@using MyCryptoPortfolio.Domain.Entities
@model MyCryptoPortfolio.Web.ViewModels.PortfolioSummaryViewModel

@{
    ViewData["Title"] = "Overview";
    var history = ViewBag.History as List<Transaction>;
}

<div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
    <div>
        <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">Overview</h1>
        <p class="text-slate-500 mt-2 text-lg">Selamat datang kembali! Berikut performa aset Anda.</p>
    </div>
    <a asp-action="Create" class="group relative inline-flex items-center justify-center px-8 py-3 font-semibold text-white transition-all duration-200 bg-slate-900 font-pj rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-900 hover:bg-slate-800 shadow-lg hover:shadow-xl hover:-translate-y-0.5">
        <i class="ph ph-plus-circle text-xl mr-2"></i> Tambah Aset
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    
    <div class="lg:col-span-2 relative overflow-hidden rounded-3xl bg-slate-900 p-8 shadow-2xl text-white group">
        <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-gradient-to-br from-brand-500 to-accent-500 blur-3xl opacity-40 group-hover:opacity-60 transition duration-700"></div>
        <div class="absolute bottom-0 left-0 -ml-16 -mb-16 w-64 h-64 rounded-full bg-gradient-to-tr from-pink-500 to-orange-400 blur-3xl opacity-30 group-hover:opacity-50 transition duration-700"></div>
        
        <div class="relative z-10">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-slate-300 font-medium mb-1">Total Balance</p>
                    <h2 class="text-5xl font-bold tracking-tight">
                        @(((decimal)ViewBag.CurrentPortfolioValue).ToString("C0", System.Globalization.CultureInfo.CreateSpecificCulture("id-ID")))
                    </h2>
                </div>
                <div class="p-3 bg-white/10 backdrop-blur-md rounded-2xl">
                    <i class="ph-fill ph-wallet text-3xl"></i>
                </div>
            </div>
            
            <div class="mt-8 flex gap-8">
                <div>
                    <p class="text-slate-400 text-sm">Modal Awal</p>
                    <p class="text-xl font-semibold">@Model.TotalInvestmentValue.ToString("N0")</p>
                </div>
                <div>
                    <p class="text-slate-400 text-sm">Total Profit</p>
                    @{
                        var totalPnL = (decimal)ViewBag.CurrentPortfolioValue - Model.TotalInvestmentValue;
                        var isProfit = totalPnL >= 0;
                    }
                    <p class="text-xl font-semibold flex items-center gap-1 @(isProfit ? "text-emerald-400" : "text-rose-400")">
                        <i class="@(isProfit ? "ph-fill ph-trend-up" : "ph-fill ph-trend-down")"></i>
                        @totalPnL.ToString("N0")
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col justify-between">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700">Allocation</h3>
            <button class="text-slate-400 hover:text-brand-600"><i class="ph ph-dots-three-outline-vertical text-xl"></i></button>
        </div>
        <div class="h-48 relative flex justify-center items-center">
            <canvas id="allocationChart"></canvas>
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <span class="text-xs text-slate-400">Top Asset</span>
                <span class="font-bold text-slate-800 text-lg" id="topAssetTicker">-</span>
            </div>
        </div>
        <div class="mt-4 flex justify-between text-sm text-slate-500">
            <span>@Model.Holdings.Count() Assets</span>
            <span>@(history?.Count() ?? 0) Txns</span>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
    
    <div class="xl:col-span-2 space-y-6">
        <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold text-slate-800">Your Assets</h3>
        </div>
        
        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto"> 
                <table class="w-full whitespace-nowrap"> <thead class="bg-slate-50/50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Asset</th>
                            <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Holding</th>
                            <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Alloc</th> <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Value</th>
                            <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">PnL</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        @foreach (var asset in Model.Holdings)
                        {
                            <tr class="hover:bg-slate-50 transition duration-150 group">
                                <td class="px-6 py-5">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold shadow-inner group-hover:bg-brand-100 group-hover:text-brand-600 transition">
                                            @asset.Ticker.Substring(0,1)
                                        </div>
                                        <div>
                                            <p class="font-bold text-slate-800">@asset.Ticker</p>
                                            <p class="text-xs text-slate-400">Crypto</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-5 text-right">
                                    <p class="text-sm font-medium text-slate-700">@asset.CurrentMarketPrice.ToString("N0")</p>
                                </td>
                                <td class="px-6 py-5 text-right">
                                    <p class="text-sm font-medium text-slate-700">@asset.TotalQuantity.ToString("N4")</p>
                                    <p class="text-xs text-slate-400">Avg: @asset.AverageBuyPrice.ToString("N0")</p>
                                </td>
                                <td class="px-6 py-5 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-brand-500 rounded-full" style="width: @(asset.AllocationPercentage)%"></div>
                                        </div>
                                        <span class="text-xs font-bold text-slate-600">@asset.AllocationPercentage.ToString("N1")%</span>
                                    </div>
                                </td>
                                <td class="px-6 py-5 text-right">
                                    <p class="text-sm font-bold text-slate-800">@asset.CurrentTotalValue.ToString("N0")</p>
                                </td>
                                <td class="px-6 py-5 text-right">
                                    <div class="flex flex-col items-end">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @(asset.PnLPercentage >= 0 ? "bg-emerald-50 text-emerald-700" : "bg-rose-50 text-rose-700")">
                                            @(asset.PnLPercentage >= 0 ? "+" : "")@asset.PnLPercentage.ToString("N2")%
                                        </span>
                                        <span class="text-xs mt-1 @(asset.UnrealizedPnL >= 0 ? "text-emerald-600" : "text-rose-600")">
                                            @(asset.UnrealizedPnL >= 0 ? "+" : "")@asset.UnrealizedPnL.ToString("N0")
                                        </span>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div> </div>
    </div>

    <div class="space-y-6">
        <h3 class="text-xl font-bold text-slate-800">Recent Activity</h3>
        <div class="space-y-4">
            @foreach (var item in history.Take(5))
            {
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition flex justify-between items-center group relative overflow-hidden">
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center @(item.Type == TransactionType.Buy ? "bg-emerald-100 text-emerald-600" : "bg-rose-100 text-rose-600")">
                            <i class="@(item.Type == TransactionType.Buy ? "ph-fill ph-arrow-down-left" : "ph-fill ph-arrow-up-right") text-xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-800">@item.Ticker</p>
                            <p class="text-xs text-slate-400">@item.Date.ToString("dd MMM, HH:mm")</p>
                        </div>
                    </div>
                    <div class="text-right relative z-10">
                        <p class="font-bold text-slate-800">@item.Quantity.ToString("N4")</p>
                        <p class="text-xs text-slate-500">@@ @item.Price.ToString("N0")</p>
                    </div>

                    <div class="absolute inset-0 bg-slate-900/90 flex items-center justify-center gap-3 opacity-0 group-hover:opacity-100 transition duration-200 z-20">
                        <a asp-action="Edit" asp-route-id="@item.Id" class="p-2 bg-white/20 text-white rounded-full hover:bg-white/40"><i class="ph-fill ph-pencil-simple"></i></a>
                        <form asp-action="Delete" asp-route-id="@item.Id" method="post" onsubmit="return confirm('Hapus?');">
                            <button type="submit" class="p-2 bg-rose-500/80 text-white rounded-full hover:bg-rose-500"><i class="ph-fill ph-trash"></i></button>
                        </form>
                    </div>
                </div>
            }
             <div class="text-center pt-2">
                <a href="#" class="text-sm text-brand-600 font-semibold hover:underline">View All History</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var assetLabels = @Html.Raw(Json.Serialize(Model.Holdings.Select(h => h.Ticker)));
        var assetValues = @Html.Raw(Json.Serialize(Model.Holdings.Select(h => h.CurrentTotalValue)));

        if (assetLabels.length > 0) {
            let maxVal = Math.max(...assetValues);
            let maxIdx = assetValues.indexOf(maxVal);
            document.getElementById('topAssetTicker').innerText = assetLabels[maxIdx];
        }

        const ctx = document.getElementById('allocationChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: assetLabels,
                datasets: [{
                    data: assetValues,
                    backgroundColor: ['#0ea5e9', '#8b5cf6', '#f43f5e', '#10b981', '#f59e0b', '#6366f1'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%', 
                plugins: {
                    legend: { display: false }
                }
            }
        });
    </script>
}